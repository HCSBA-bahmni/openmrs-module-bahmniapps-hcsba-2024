<div class="modern-modal-wrapper" aria-labelledby="dialog-label">
    <div class="modern-modal">
        <div class="ngdialog-close clearfix"></div>

        <div class="modern-modal-body p-2">
            <div class="modern-modal-section p-fluid">

                <p class="mb-3">
                    {{ 'PATIENT_ID_KEY' | translate }}:
                    <strong>{{ patient.name }} ({{ patient.identifier }})</strong>
                </p>

                <div class="visit-dynamic-group">
                    <!-- Header visitas -->
                    <div class="flex align-items-center justify-content-between mb-3">
                        <h4 id="dialog-label" class="m-0">{{ 'VISITAS_KEY' | translate }}</h4>
                        <button type="button"
                                class="modern-button modern-button-secondary btn-icon"
                                ng-click="addVisita()"
                                ng-disabled="visitas.length >= 3">
                            <i class="pi pi-plus"></i>
                            <span>{{ 'AGREGAR_VISITA_KEY' | translate }} ({{visitas.length}}/3)</span>
                        </button>
                    </div>

                    <!-- Item de visita -->
                    <div class="visit-item modern-card mb-3" ng-repeat="v in visitas track by $index">
                        <!-- Encabezado item -->
                        <div class="flex align-items-center justify-content-between mb-2">
                            <strong>{{ 'VISITA_N_KEY' | translate:{n: ($index + 1)} }}</strong>
                            <button type="button"
                                    class="modern-button modern-button-secondary"
                                    ng-click="removeVisita($index)"
                                    ng-if="visitas.length > 1"
                                    title="{{ 'ELIMINAR_KEY' | translate }}">
                                <i class="pi pi-trash"></i>
                            </button>
                        </div>

                        <!-- Fila 1: Doc / Nombre / Contacto -->
                        <div class="grid formgrid">
                            <div class="col-12 md:col-4">
                                <div class="field">
                                    <label for="doc-{{$index}}">{{ 'NRO_DOC_VISITA_KEY' | translate }}</label>
                                    <input id="doc-{{$index}}" type="text" ng-model="v.doc" required
                                           placeholder="{{ 'PLACEHOLDER_DOC_KEY' | translate }}"/>
                                </div>
                            </div>

                            <div class="col-12 md:col-4">
                                <div class="field">
                                    <label for="nombre-{{$index}}">{{ 'NOMBRE_COMPLETO_KEY' | translate }}</label>
                                    <input id="nombre-{{$index}}" type="text" ng-model="v.nombre" required
                                           placeholder="{{ 'PLACEHOLDER_NOMBRE_KEY' | translate }}"/>
                                </div>
                            </div>

                            <div class="col-12 md:col-4">
                                <div class="field">
                                    <label for="contacto-{{$index}}">{{ 'CONTACTO_KEY' | translate }}</label>
                                    <input id="contacto-{{$index}}" type="tel" ng-model="v.contacto" required
                                           placeholder="{{ 'PLACEHOLDER_CONTACTO_KEY' | translate }}"/>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 2: Pueblo originario / Parentesco -->
                        <div class="grid align-items-center">
                            <div class="col-12 md:col-8">
                                <div class="field">
                                    <label for="parentesco-{{$index}}">{{ 'PARENTEZCO_KEY' | translate }}</label>
                                    <select id="parentesco-{{$index}}"
                                            ng-model="v.parentesco"
                                            ng-options="p as p.description for p in parentescos track by p.id"
                                            ng-disabled="!parentescos.length" required>
                                        <option value="">{{ 'SELECCIONE_PARENTESCO_KEY' | translate }}</option>
                                    </select>
                                    <small class="help" ng-if="!parentescos.length">
                                        {{ 'CARGANDO_KEY' | translate }}...
                                    </small>
                                </div>
                            </div>
                            <div class="col-12 md:col-4">
                                <label class="inline-flex align-items-center gap-2" for="pueblo-{{$index}}">
                                    <input id="pueblo-{{$index}}" type="checkbox" ng-model="v.puebloOriginario"/>
                                    <span>{{ 'PUEBLO_ORIGINARIO_KEY' | translate }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comentarios -->
                <div class="mt-3">
                    <label class="block mb-1" for="obs">{{ 'COMENTARIO_KEY' | translate }}</label>
                    <textarea id="obs" rows="4" ng-model="form.customComment"></textarea>
                </div>

            </div>

            <!-- Footer -->
            <div class="modern-modal-footer flex justify-content-end gap-2 mt-3">
                <button id="modal-revise-button1"
                        class="modern-button modern-button-primary"
                        ng-click="confirmCustomAction()"
                        ng-disabled="isVisitasInvalid() || saving">
                    {{ 'SAVE_KEY' | translate }}
                </button>
                <button id="modal-revise-button3"
                        class="modern-button modern-button-secondary"
                        ng-click="closeThisDialog()">
                    {{ 'CANCEL_KEY' | translate }}
                </button>
            </div>
        </div>
    </div>
</div>
